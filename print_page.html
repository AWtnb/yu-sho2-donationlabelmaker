<!DOCTYPE html>
<!-- thanks https://qiita.com/okoppe8/items/f3b3e7688c98537512ea -->
<html lang="ja">
<meta charset="utf-8"/>
<head>
    <title>print page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.3.0/paper.css">
    <link rel="stylesheet" type="text/css" href="./css/print.css">
</head>
<body class="A4">
    <section class="sheet" id="topSheet">
        <table class="print">
            <tbody>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </section>
<script>
String.prototype.bytes = function () {
    let length = 0;
    for (let i = 0; i < this.length; i++) {
        const c = this.charCodeAt(i);
        if ((c >= 0x0 && c < 0x81) || (c === 0xf8f0) || (c >= 0xff61 && c < 0xffa0) || (c >= 0xf8f1 && c < 0xf8f4)) {
            length += 1;
        } else {
            length += 2;
        }
    }
    return length;
};
window.onload = function(){
    const sourceTable = window.opener.document.querySelector('#table1');
    const data = [];
    for (let r = 1; r < sourceTable.rows.length; r++) {
        let row = sourceTable.rows[r];
        data.push({
            name:    (row.cells[0].innerText || ""),
            title:   (row.cells[1].innerText || ""),
            place:   (row.cells[2].innerText || ""),
            zipcode: (row.cells[3].innerText || ""),
            address: (row.cells[4].innerText || ""),
            from:    (row.cells[5].innerText || ""),
        });
    }
    // add print sheet if needed
    let nSheet = Math.ceil(data.length / 8);
    if (nSheet > 1) {
        const topSheet = document.querySelector("#topSheet");
        for (let n = 0; n < nSheet - 1; n++) {
            let wrapper = document.createElement("section");
            wrapper.innerHTML = topSheet.outerHTML;
            document.body.appendChild(wrapper);
        }
    }
    // markup data as html with html template.
    const conditionForm = window.opener.document.form_condition;
    const markup = data.map(d => {
        let markupHTML =
            `<div class="toArea">` +
                `<div class="stamp">謹 呈</div>` +
                `<div class="editable">` +
                    `<p class="zipcode">〒${d.zipcode}</p>` +
                    `<div class="addressBlock">` +
                        `<p class="address">${(d.address).replace(/[\r?\n]/g, "<br>")}</p>` +
                        `<p class="place">${(d.place).replace(/[\r?\n]/g, "<br>")}</p>` +
                    `</div>` +
                    `<div class="nameBlock">` +
                        `<p class="name">${(d.name).replace(/[\r?\n]/g, "<br>").replace(/(^.+?)<br>/, '<span class="sub">$1</span><br>')}<span class="title">${d.title}</span></p>` +
                    `</div>` +
                `</div>` +
            `</div>` +
            `<div class="fromArea">` +
                `<div class="addressBlock">` +
                    `<div class="company"><span class="kabuMark">&#x337F;</span><span class="companyName">有斐閣</span><span class="department">書籍編集第2部</span></div>` +
                    `<div class="address">〒101-0051 東京都千代田区神田神保町2-17</div>` +
                `</div>` +
                `<div class="contact">` +
                    `<p><span class="tel">電話</span><span class="num">03(3264)1315番</span></p>` +
                    `<p><span class="fax">FAX</span><span class="num">03(3264)4630番</span></p>` +
                    `<p class="url">http://www.yuhikaku.co.jp/</p>` +
                `</div>` +
                `<div class="editable">` +
                    `<div class="nameBlock"><p>${(d.from).replace(/[\r?\n]/g,"<br>")}</p></div>`;
        if (conditionForm.yuMailFlag.checked) {
            markupHTML = markupHTML + `<div class="stamp"><p>ゆうメール</p></div>`
        }
        if (conditionForm.viaFlag.checked) {
            markupHTML = markupHTML + `<div class="via">気付</div>`
        }
        return markupHTML + `</div></div>`;
    });
    // overwrite each td.
    let labelIndex = 0;
    const printTable = document.querySelectorAll(".print");
    for (let i = 0; i < printTable.length; i++) {
        const targetTable = printTable[i];
        const cells = targetTable.querySelectorAll("td");
        for (let c = 0; c < cells.length; c++) {
            cells[c].innerHTML = markup[labelIndex];
            const addressBlock = cells[c].querySelector(".toArea .addressBlock");
            const address = addressBlock.querySelector(".address");
            if (address.textContent.bytes() >= 20 * 2) {
                address.style.fontSize = "11pt";
            }
            const place = addressBlock.querySelector(".place");
            if (place.textContent.bytes() >= 20 * 2) {
                place.style.fontSize = "11pt";
            }
            const nameBlock = cells[c].querySelector(".toArea .nameBlock");
            const nameSpan = nameBlock.querySelector(".name");
            const titleSpan = nameBlock.querySelector(".title");
            if (nameSpan.textContent.length >= 8) {
                nameSpan.style.fontSize = "18pt";
                titleSpan.style.fontSize = "14pt";
                nameBlock.style.textAlign = "start";
            }
            labelIndex += 1;
            if (labelIndex == markup.length) {
                labelIndex = 0;
                cells[c].style.borderBottomColor = "#999";
                cells[c].style.borderRightColor = "#999";
            }
        }
    }
    const editable = document.querySelectorAll(".editable");
    Array.from(editable).forEach(el => {
        el.setAttribute("contenteditable", "true");
    });
}
</script>
</body>
</html>